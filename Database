# topdb.py
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Handles the database operations for Top Movies collection.
# Uses MongoDB to store, fetch, and manage top-rated movies.
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

from pymongo import MongoClient, errors

class TopDB:
    """
    TopDB is responsible for managing the 'top_movies' collection.
    It supports inserting, retrieving, and clearing top-rated movies.
    """

    def __init__(self, uri: str = "mongodb://localhost:27017/", db_name: str = "movie_bot_db"):
        try:
            self.client = MongoClient(uri, serverSelectionTimeoutMS=5000)
            # Trigger connection check
            self.client.server_info()
            print("[âœ…] Connected to MongoDB successfully!")

            self.db = self.client[db_name]
            self.collection = self.db["top_movies"]

        except errors.ServerSelectionTimeoutError:
            print("[âŒ] MongoDB connection failed! Please check your URI or network.")
            self.client = None
            self.db = None
            self.collection = None

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Insert a new movie document
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def insert_movie(self, movie_data: dict):
        if not self.collection:
            print("[âš ï¸] No database connection.")
            return None
        if not isinstance(movie_data, dict):
            print("[âš ï¸] Invalid movie data format. Must be a dictionary.")
            return None
        try:
            result = self.collection.insert_one(movie_data)
            print(f"[+] Inserted movie: {movie_data.get('title', 'Unknown')}")
            return result.inserted_id
        except Exception as e:
            print(f"[âŒ] Error inserting movie: {e}")
            return None

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Get top movies sorted by rating (descending)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def get_top_movies(self, limit: int = 10):
        if not self.collection:
            print("[âš ï¸] No database connection.")
            return []
        try:
            movies = list(self.collection.find().sort("rating", -1).limit(limit))
            print(f"[ğŸ“œ] Retrieved {len(movies)} top movies.")
            return movies
        except Exception as e:
            print(f"[âŒ] Error fetching top movies: {e}")
            return []

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Clear all top movies from the collection
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def clear_top_movies(self):
        if not self.collection:
            print("[âš ï¸] No database connection.")
            return 0
        try:
            result = self.collection.delete_many({})
            print(f"[ğŸ§¹] Cleared {result.deleted_count} movie(s) from top list.")
            return result.deleted_count
        except Exception as e:
            print(f"[âŒ] Error clearing top movies: {e}")
            return 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Close MongoDB connection safely
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    def close_connection(self):
        if self.client:
            self.client.close()
            print("[ğŸ”’] MongoDB connection closed.")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Example usage (for testing)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if __name__ == "__main__":
    db = TopDB(uri="mongodb://localhost:27017/")

    # Insert a sample movie
    db.insert_movie({
        "title": "Inception",
        "rating": 9.0,
        "year": 2010,
        "genre": ["Action", "Sci-Fi"],
        "director": "Christopher Nolan"
    })

    # Retrieve top movies
    top_movies = db.get_top_movies(limit=5)
    for movie in top_movies:
        print(f"ğŸ¬ {movie['title']} â€” â­ {movie['rating']}")

    # Optional: clear all movies
    # db.clear_top_movies()

    # Close DB connection
    db.close_connection()
